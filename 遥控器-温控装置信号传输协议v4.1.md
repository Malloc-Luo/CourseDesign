## 遥控器-温控装置信号传输协议v4.1



### 一、下位机与上位机串口通信协议：

上位机遥控器端蓝牙串口做为`master`，下位机蓝牙串口做`slaver`。串口参数：

*   波特率：9600
*   停止位：1
*   校验方式：无校验
*   帧长度：8 bit

每一帧数据有4 byte，分为 起始帧，指令帧，数据帧。

| Byte |       Note        |
| :--: | :---------------: |
|  1   | 0xA5 Frame Header |
|  2   |      指令帧       |
|  3   |    数据帧高8位    |
|  4   |    数据帧低8位    |

#### 数据位：

数据位为`%3.1f`类型的浮点数乘以10之后强制转换成`uint16_t`的数据，大小为0~999

#### 控制位：

控制位指示数据位的类型，占4bit

| Value             | Note               |
| ----------------- | ------------------ |
| 0x01  `SET_VAL`   | 数据位为温度设定值 |
| 0x02  `ACTUL_VAL` | 数据位为温度当前值 |
| 0x04  ` RESET`    | 重置温度最低值     |
| `Value` \| 0xf0   | 强制同步模式       |

#### 强制同步模式：

为了避免数据发生冲突而加入强制同步模式，下位机蓝牙模块由离线转为在线模式后的2400ms内为强制同步模式，此时下位机发送控制位的搞四位为`0xf`，在强制同步模式下：

*   温控模块、遥控模块的按键不可用
*   温控模块的不在串口中断中改变设定值、参考值、实际值
*   遥控模块解析指令时需要将接收到的指令按位与`0x0f`

### 二、程序实现示例：

合成发送数据帧：

```c
float tempf;
int16_t tempi= (int16_t)(tempf * 10);
uint8_t construction;

void bt_send_data(uint8_t *cmd, int16_t *dat)
{
    uint8_t * ptr = (uint8_t *)dat;
    /* 数据帧头0xa5 */
    uart_send(FRAME_HEADER);
    /* 指令帧 */
    uart_send(*cmd);
    /* 数据帧 */
    uart_send(*(ptr + 0));
    uart_send(*(ptr + 1));
}
```

还原接收数据帧：

```c
uint8_t instruct = Buffer[1];
int16_t temp = *(int16_t *)(Buffer + 2);
```